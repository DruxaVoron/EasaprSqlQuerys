<!DOCTYPE html>
<html>
<head>
<title>Запрос данных о вагонах и отправках в ЭТРАН</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="content-type" content="text/html; charset=windows-1251">
<Link REL='stylesheet' TYPE='text/css' HREF='/common/easapr.css'>
<link rel="stylesheet" type="text/css" href="/arg/css/arg_style.css"/>
<script type="text/javascript" src="/common/dtable.js"></script>
<script type="text/javascript" src='/common/json2.js'></script>
<script type="text/javascript" src='/common/lib.js'></script>
<script type="text/javascript" src='/common/jquery-1.7.js'></script>
<script type="text/javascript" src="/arg/Fun/addSomeFun.js"></script>
<script type="text/javascript">
var Load;
window.returnValue = {};
//========================================================================================
function init(){
	// Дорисовываем кнопки и лоадим jUI
	addBut('someBut',{'dateNow':'','help':'help()'},true);
	CreateHead(['jUI']);
	// Вешаем обработчик на переключение списков
	$("input[name^='SearchBy']:radio").click(function(){
		$('#tablCar,#tablSend').addClass('blured');
		$('#tabl'+this.value).removeClass('blured');
	});
	// Вешаем обработчик "выбрать всё"
	$("#checkAll").click(function(){ $("input[name^='ch']:checkbox").not(this).prop('checked', this.checked); });
	
	$('[title*=]').tooltip({ track: true, show: {delay:800} });
	
	// Загружаем входящие параметры
	if (window.dialogArguments){
		Load = window.dialogArguments;
		if (Load) DataLoad();
	}
	
	$('body').show(200, function(){ resize(); });// << открываем все окно
}
//========================================================================================
// Запрос ЭТРАН и обрабока полученных данных
function SearchInEtran(){
	$('.RedScull').removeClass('RedScull');
	try {
		var radio = $("input[name^='SearchBy']:checked");
		if (!radio.length) throw new UserExc('Выберите тип поиска.','radio');
		
		// Собираем данные для запроса
		var obj = {'vagstr':[], 'sendstr':[]};
		switch (radio.val()){
			case 'Car':
				$('#tablCar tr').each(function(){
					var v = $(this).find('td:eq(0)').html();
					if (v) obj.vagstr.push( v ); 
				});
				break;
			case 'Send':
				$('#tablSend tr').each(function(){
					var v = $(this).find('td:eq(0)').html();
					if (v) obj.sendstr.push( v ); 
				});
				break;
			default: return;
		}
		if (!obj.vagstr.length && !obj.sendstr.length) return;
		sh.show();
		// Если запрос по вагонам спрашиваем, что получить [указанное/всё]
		obj.ask = obj.vagstr.length && $('#AskCarsOnly').is(':checked');
		
		// Очищаем результирующую таблицу и запрашиваем ЭТРАН
		$("#tablRes tr:gt(0)").remove();
		send_object(obj,'/aof/interfaces/etran_ask_interface.php',function(res){
			try {
				if ($.isEmptyObject(res))
					throw new UserExc('Ответ от системы ЭТРАН не пришел или пришел, но пустой. Попробуйте запросить данные еще раз.');
				if (res[0] && res[0].err)
					throw new UserExc("Ошибка системы ЭТРАН:\n" + res[0].err);
				if (typeof(res)=='string')
					throw new UserExc(res);
				
				// Заполняем результирующую таблицу
				$.each(res,function(i,dataCar){
					var t = {'send':[], 'cont':[]}
					$(dataCar.shipment).each(function(){
						if (this.send && $.inArray(this.send.sendNum, t.send) < 0)
							t.send.push( this.send.sendNum );
						if (this.cont && $.inArray(this.cont.contNum, t.cont) < 0)
							t.cont.push( this.cont.contNum );
					});
					
					var row = addRow('tablRes');
					row.find('td.numPP').html(++i);
					row.find('td.carNum').html(dataCar.carNum);
					row.find('td.sendNum').html(t.send.join("<br>"));
					row.find('td.contNum').html(t.cont.join('<br>'));
					row.find('td.isDetached').html(dataCar.carDetached-0? 'X' : '');
					
					dataCar.carOwnerName = dataCar.carOwner;
				});
				// Записываем данные от ЭТРАН в выходной объект
				window.returnValue.car = res;
				sh.hide();
			} catch(e) {
				sh.hide();
				if (e.message) alert(e.message);
			}
		});
	} catch(e) {
		sh.hide();
		if (e.t == 'radio') $("input[name^='SearchBy']").parent().addClass('RedScull');
		if (e.message) alert(e.message);
	}
}
//========================================================================================
// Получить выбранные вагоны и закрыть окно
function GetAndReturn(){
	var Select_Car = [];
	$("#tablRes td>input[name^='ch']:checked").parents('tr').each(function(i){
		var v = $(this).find('td.carNum').html();
		if (v) Select_Car.push( v );
	});
	// Записываем выбранные выгоны в выходной объект
	var obj = window.returnValue;
	obj.s_Car = (Select_Car.length)? Select_Car.join(',') : '';
	obj.AddOrReplace = $('[name=ReturnType]:checked').val();
	self.close();
}
//========================================================================================
// Загрузка полученных из АОФ вагонов/отправок
function DataLoad(){
	if ($.isEmptyObject(Load.a_Car) && $.isEmptyObject(Load.a_Send)) return;
	
	if (Load.a_Car.length){
		$.each(Load.a_Car,function(i,v){
			var row = addRow('tablCar');
			row.find('td:eq(0)').html(v);
		});
		if (!Load.a_Send.length) $(":radio[value=Car]").click();
	}
	if (Load.a_Send.length){
		$.each(Load.a_Send,function(i,v){
			var row = addRow('tablSend');
			row.find('td:eq(0)').html(v);
		});
		if (!Load.a_Car.length) $(":radio[value=Send]").click();
	}
}
//========================================================================================
// Добавить/удалить значение таблицы
function addValue(){
	$('.RedScull').removeClass('RedScull');
	var elValue = $('#addValue');
	var str = elValue.val();
	if (!str) return;
	try {
		var elRadio = $("input[name^='SearchBy']:checked");
		if (!elRadio.length) throw new UserExc('Выберите тип поиска.','radio');
		var radio = elRadio.val();
		
		str = str.replace(/[^a-zA-ZА-Яа-я0-9]/g,',');
		var arr = str.split(',');
		for (var i in arr){
			var num = arr[i];
			if (radio == 'Car') {
				num = num.replace(/[^0-9]/g,'');
				if (!CheckCarNum(num)) continue;
			}
			if (radio == 'Send') {
				if (!CheckSendNum(num)) continue;
			}
			if (!num) continue;
			
			var row = addRow('tabl'+radio);
			row.find('td:eq(0)').html(num);
		}
		elValue.val('').focus();
		var div = $('#tabl'+radio).parent();
		$(div).animate({ scrollTop: $(div).prop("scrollHeight")}, 1000 );
		
		
	} catch(e) {
		sh.hide();
		if (e.t == 'radio') $("input[name^='SearchBy']").parent().addClass('RedScull');
		if (e.message) alert(e.message);
	}
}

function CheckCarNum(val) {
	val = val.replace(/ /g,'');
	if (!val) return false;
	var t = '00000000';
	val = (t + val).slice(-8);
	if (val == t) return false;
	
	for (var a,s=0,i=1; i<9; i++) {
		a = val.substr(i-1,1)*(i -( Math.floor(i/2)*2 )+1);
		s += Math.floor(a/10)+(a-( Math.floor(a/10)*10 ));
	}
	if (s-(Math.floor(s/10)*10) != 0) return false;
	return true;
}

function CheckSendNum(val) {
	val = val.replace(/ /g,'').toUpperCase();
	if (!val) return false;
	
	var reg_1=new RegExp('^[А-Я]{0,2}\\d{4,8}$');
	var reg_2=new RegExp('^[A-Z]{0,2}\\d{1,10}$');
	
	if (val.match(reg_1)) return true
	if (val.match(reg_2)) return true;
	return false;
}

//========================================================================================
function delValue(t){
	if (typeof t=='string') $('#tabl'+t+' tr:gt(0)').remove();
	$(t).parents('tr').remove();
}
//========================================================================================
function addRow(t){
	var r = $('#'+t+' tr:last');
	var n = r.clone().show();
	r.after(n);
	return n;
}
//========================================================================================
// Открыть "помощь"
function help(){
	sh.count? sh.hide() : sh.show();
	$('#helpDiv').toggle();
}
//========================================================================================
function resize(){
	var w = document.body.clientWidth;
	var w_2 = w-56-$('.fixH:eq(0)').width();
	$('.fixH:eq(1)').width(w_2);
	$('#ResTab').width(w_2-10);
	$('#ResTab table').width(w_2-27);
	
	var h = document.body.clientHeight;
	$('.fixH').height(h-50);
	$('.scrollDiv').height(h-295);
	$('#ResTab .scrollDiv').height(h-165);
}
//========================================================================================
function UserExc(message,t) {
	this.t = t;
	this.message = message;
	this.name = "Исключение, определенное пользователем";
}

//========================================================================================
</script>
<style>
	label, button, img {
		cursor : pointer;
	}
	.fixH{
		float: left;
		border: 2px solid #acacac; 
		padding:4px;
		margin: 4px 8px;
	}
	.fixH legend{
		margin-left: 20px;
	}
	.fixH legend p {
		font-size: 1.5em;
		text-align :center;
	}
	.tabs{
		width:150px;
		float:left;
	}
	div.scrollDiv {
		height:150px;
		overflow-y:auto;
	}
	table.tabl {
		width:130px;
		table-layout:fixed;
	}
	.tab_r2	{
		text-align: center;
		font-size:1.2em;
	}
	.tab_del {
		text-align: center;
		vertical-align: middle;
		width: 20px;
		padding-top: 2px;
	}
	.tab_del img {
		width:17px;
		height:17px;
	}
	button.add {
		height:27px;
		margin-right: 15px;
		margin-left: 5px;
		font-size:1em;
		vertical-align: middle;
	}
	.blured{
		color:dimGray;
		opacity:0.2;
		filter: alpha(opacity=50);
	}
	#helpDiv{
		position:absolute;
		top:15%;
		left:10%;
		width:80%;
		height:70%;
		
		padding:5px;
		font-size:1.4em;
		font-family:Georgia, 'Times New Roman', Times, serif;
		z-index:102;
		background-color:#FFF4C1;
		box-sizing: border-box;
		border: 35px outset DarkRed;
	}
</style>
</head>
<body onload = 'init();' style = 'display:none;'>
	<div id='sh'></div>
	<div id='someBut'></div>
	
	<fieldset class=fixH style='width:315px;'>
		<legend><p class='ph' style='color:dimGray;'>Данные для поиска</p></legend>
		<div class="div_parent" style="width:100%;height:130px;">
			<div class="div_child">
				<textarea id=addValue style="width:100%; height:90px;"></textarea>
			</div>
			<div class="div_child" style='text-align:center;'>
				<button class="add" style='width:100px; margin-top:5px;' onclick='addValue();' title='Добавить данные в выбранную таблицу'>Добавить</button>
			</div>
		</div>
		<div><hr></div>
		
		<div id=CarTab class=tabs>
			<table class=tabl style="height:5%;">
				<tr class=trh>
					<td class=tab_r2 style='text-align:left;'>
						<input name='SearchBy' style='margin: 0px 5px;' type='radio' value='Car' checked>Вагоны
					</td>
					<td class='td1 tab_del' title='Удалить все вагоны'>
						<img src='/common/img/remove.png' onclick="delValue('Car');">
					</td>
				</tr>
			</table>
			<div class=scrollDiv>
				<table id="tablCar" class=tabl>
					<tr style='height:25px;display:none;'>
						<td class='td1 tab_r2'></td>
						<td class='td1 tab_del'>
							<img src='/common/img/remove.png' onclick='delValue(this);'>
						</td>
					</tr>
				</table>
			</div>
		</div>
		<div id=SendTab class=tabs>
			<table class=tabl style="height:5%;">
				<tr class=trh>
					<td class=tab_r2 style='text-align:left;'>
						<input name='SearchBy' style='margin: 0px 5px;' type='radio' value='Send'/>Отправки
					</td>
					<td class='td1 tab_del' title='Удалить все отправки'>
						<img src='/common/img/remove.png' onclick="delValue('Send');">
					</td>
				</tr>
			</table>
			<div class=scrollDiv>
				<table class=tabl id="tablSend">
					<tr style='height:25px;display:none;'>
						<td class='td1 tab_r2'></td>
						<td class='td1 tab_del'><img src='/common/img/remove.png' onclick='delValue(this);'></td>
					</tr>
				</table>
			</div>
		</div>
		
		<div class="div_parent" style="width:100%;height:30px;">
			<div><hr></div>
			<div class="div_child">
				<table class="grayTable" style="width:100%; height:30px; table-layout:fixed;">
					<tr>
						<td style="width:20px;">
							<input type='checkbox' checked id=AskCarsOnly class='tab_ch' style="vertical-align:middle;">
						</td>
						<td>
							<label for='AskCarsOnly' class="ph">Поиск только по указанным номерам вагонов</label>
						</td>
						<td style="width:50px;">
							<button class="add" style='width:40px;' onclick='SearchInEtran();blur();' title='Запрос АС ЭТРАН выбранным методом'>
								<img src='/common/etran.gif' style='width:13'>
							</button>
						</td>
					</tr>
				</table>
			</div>
		</div>
	</fieldset>
	
	
	<fieldset class=fixH style='width:400px;'>
		<legend><p class='ph' style='color:dimGray;'>Данные, полученные из ЭТРАН</p></legend>
		<div class="div_parent" style="width:100%; height:50px;">
			<table class="grayTable" style="width:100%; table-layout:fixed; margin-top:5px;">
				<tr>
					<td rowspan=2 style="width:185px;">
						<button class="add" style='width:165px;' onclick='GetAndReturn();'>Выбрать и закрыть</button>
					</td>
					<td style="width:20px;">
						<input id='ReturnTypeAdd' name='ReturnType' type='radio' value='Add'>
					</td>
					<td>
						<label for='ReturnTypeAdd' class="ph">Добавить вагоны в акт</label>
					</td>
				</tr>
				
				<tr>
					<td style="width:20px;">
						<input id='ReturnTypeReplace' name='ReturnType' type='radio' value='Replace' checked>
					</td>
					<td>
						<label for='ReturnTypeReplace' class="ph">Заменить вагоны в акте</label>
					</td>
				</tr>
			</table>
		</div>
		<div><hr></div>
		
		<div id=ResTab class=tabs style='width:440px;'>
			<table  style="width:420px;height:5%;table-layout:fixed;">
				<tr class=trh>
					<td style='width:28px;text-align:center;'>
						<input type='checkbox' id=checkAll style='background-color:#D4D0C8;top:5;left:0;'>
					</td>
					<td class=tab_r2 style='width:35px;'>#</td>
					<td class=tab_r2>Вагон</td>
					<td class=tab_r2>Отправка</td>
					<td class=tab_r2>Контейнер</td>
					<td class=tab_r2 style='width:53px;'>Отцеп</td>
				</tr>
			</table>
			<div class='scrollDiv'>
				<table id="tablRes" style="width:420px;table-layout:fixed;">
					<tr style='display:none;'>
						<td class=td1 style='width:28px;text-align:center;'>
							<input type='checkbox' name=ch style='background-color:white;top:5;left:0;'>
						</td>
						<td class='td1 tab_r2 numPP' style='width:35px;'></td>
						<td class='td1 tab_r2 carNum'></td>
						<td class='td1 tab_r2 sendNum'></td>
						<td class='td1 tab_r2 contNum'></td>
						<td class='td1 tab_r2 isDetached' style='width:53px;'></td>
					</tr>
				</table>
			</div>
		</div>
	</fieldset>
	
	<div id=helpDiv style='display:none;'>
		<button onclick='help();' style='position:absolute;right:-30px;top:-30px;width:30px;height:30px;padding:0px;'>
			<img width=17 height=17 src='/common/red_cross.png'>
		</button>
		<div style='height:100%;overflow-y:auto;'>
			Данный режим предназначен для запроса данных о вагонах и отправках из АС ЭТРАН (далее "этран").<br>
			На текущий момент ЕАСАПР может запросить этран по списку вагонов <b>или</b> по списку отправок. При запросе:<br>
			<ul style='margin:0;'>
				<li>по списку отправкок: для каждого номера отправки этран присылает массив отправок, из которого ЕАСАПР автоматически выбирает вариант <b>с максимальным ID</b>, т.е. последнюю созданную отправку, и считает ее актуальной.</li>
				<li>по списку вагонов: для каждого вагона этран присылает <b>ровно одну отправку</b>, которую этран считает актуальной. Т.к. <b>других вариантов нет</b>, ЕАСАПР так же считает ее актуальной.</li>
			</ul>
			<br>Получив список ID отправок, ЕАСАПР повторно отправляет запрос в этран по этому списку. Полученные данные отправок разбираются и отображаются в режиме.
			<br><hr><br>В раздел "Данные для поиска" подкачиваются вагоны и отправки, введенные во вкладке "Вагоны" в форме составления АОФ.
			<br>Для запроса этран нужно выбрать, каким методом будет происходить запрос (по отправкам или по вагонам). В список вагонов или отправок можно добавить необходимые номера или удалить данные, по которым запрос не нужен. 
			<br><br><ul style='margin:0;'>
				<li>для добавления нужно выбрать тип запроса, установив флаг в соответствующей таблице (вагоны по-умолчанию), ввести номер отправки/вагона в специальное поле и нажать кнопку "Добавить". Так же доступен ввод большого колличества данных, которые перечислены через запяту или пробел. Например "Отправка1,Отправка2,..." или "Вагон1,Вагон2",.."</li>
				<li>для удаления нужно нажать красный крест в строке с номером, который требуется удалить. Так же можно очистить всю таблицу, нажав кнопку с крестом в заголовке таблицы.</li>
			</ul>
			<br>Для запроса ЭТРАН нужно нажать кнопку "Э". После получения данных можно выбрать, какие именно вагоны добавить в акт. Для этого нужно отметить строки галочками и нажать кнопку "Выбрать и закрыть".
		</div>
	</div>
	
	<script src="/arg/sh.js"></script>
</body>
</html>